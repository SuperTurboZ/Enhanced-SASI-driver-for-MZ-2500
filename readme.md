# Enhanced SASI driver for MZ-2500

## 概要
SHARP MZ-2500シリーズで SASI-HardDisk (以下HDと略す）の機能をサポートする為のデバイスドライバROMです。  
入手性の悪いMZ-1E30が無くてもエミュレーターや互換基板などでもHD環境を利用できるようにする目的で開発しました。  
MZ-1E30と互換性のあるSASIインターフェース回路、並びにIPLがサポートする起動用ROMデバイスに適合します。  
最大４ドライブに対してユニバーサルなパーティション分割設定を行うことが可能です。  
対象ドライブは各種SASI-HDエミュレータで実HDDの接続は考慮されていません。  
  
## 注意事項
本ソフトウェアは主に [MZ-1E30(MZ-2500/2800用HDD I/Fボード)](http://retropc.net/ohishi/museum/mz1e30.htm)
の記事やWebやSNSなどから得たMZ-1E30の振る舞いやMZ-2500本体のIOCSの情報などを基に独自開発されています。  
MZ-1E30のROMコードは直接参照しておらず他の著作コードを含んでいませんが著作者がこれを保証するものではありません。    
また十分な動作確認が行われていないため、潜伏バグなどによりHDやFDなどのデータや装置が破損する可能性があります。  
これらの点にご留意いただき、利用者の自己責任においてご利用願います。  

## できること
* MZ-1E30互換回路やMZ-2500エミュレータなどにおいて、Hard Disk用代替BIOS-ROMとして利用すること
* 物理フォーマット済みのSASI-HDエミュレータやHDイメージにアクセスすること
* MZ-1E30では出来ない自由なパーティション割り当て

## できないこと
* リセット時に初期設定コマンドを必要とする実HDなどの安全なアクセス  
  未確認ですが純正HDのMZ-1F23は使用不可と思われます。動作する場合でも不適合条件によって故障する可能性があります。  

* エラー発生時にバスリセット以外の復帰シーケンスを必要とするHD等の利用  

* IOCSのメモリエリア 0x0F00-0x0FFF を利用するソフトとの共存（一部のゲーム等）  

* MZ-1E30のROMに収録されている拡張ファイル機能の利用  
　MZ-1E30を所有している場合はROMからファイルを抽出することで利用可能です。  
* 物理フォーマット

## わかっていないこと

* 全てのIOCS/IPL-ROMバージョンに対応できているか  

* 本ROM付属ソフトで論理フォーマットされたものがMZ-1E30標準ROMで利用できるか

* HDのデバイススクリプタにおける ziseg パラメータの値  
  メモリ関係のデバイスのが持つ連番の次の値をセットしています。調査不十分の為、なんらかの不具合が出る可能性があります。  

* MZ-1E30 / HD25Iが発行している初期化コマンド  
  何も発行していません。物理HDはサポート対象外です。  

* HD25Iのパーティション情報  

## 周知の問題点
* 全てのパーティションに起動指定がない場合でもFD優先で起動しない

## 注意点、制限

* ドライブ初期化用のコマンドは何も発行していません  
  設定コマンドが必要な物理HDでは誤動作や、適切な初期値を持たない  
  ドライブとコントローラの組み合わせでは最悪の場合ドライブが  
  故障する可能性があります。  

* ID=0,LUN=0,LAD=0x00_0003 セクタをパーティション情報として占有します   
  このブロックを利用できないシステムのイメージは利用できません。  

## インストール方法

* 実機の場合  
　SASIROM.BIN を256Kbit P-ROM等に書き込んでMZ-1E30用ROMと交換します。

* エミュレータの場合  
　エミュレーターの仕様に合わせて、SASIROM.BIN を FILE.ROM 等に  
　リネームして所定の位置に配置するなどでROMデバイスとして認識させます。  
　エミュレータがHD機能のエミュレートに対応している必要があります。  

* HDDエミュレータ/HDイメージを正しく接続した状態でFD1からBASIC M25  
　を起動してから  
　`RUN "ROM:HD PARTITION.m25"`  
　としてパーティション管理ツールを起動、本ソフト独自のパーティション  
　情報をHDに書き込んでから再起動します。  
　操作方法は`「HDパーティションデータの生成と管理」`の項目を参照してください。  

* パーティションレコード生成後に再起動したら、インストーラ起動時に  
  キーボードから'1' を押して再びFD1からBASIC M25 を再び起動します。
  `RUN "ROM:HD FORMAT.m25"`  
　を実行して FD1 を使って HD1 にシステムディスクを生成すると、HD1から  
　BASIC M25をIPL起動できるようになります。  
　操作方法は`「各パーティションの初期化(論理フォーマット)」`の  
　項目を参照してください。  

## 使い方

本ROMイメージが起動ROMデバイスとして実装されている場合、IPLはFDより
優先的に起動ROMのHDインストーラーを起動します。

HDインストーラー起動時にはシステムチェックを行い、下記の条件に従って起動動作を行います。  
| 起動時の状態 | 動作 | 
|:---:|:---|
|IPL/IOCSの確認に失敗|エラー表示をしてシステム停止（利用不可)|
|SHIFTキーが押されている| HDドライバを拡張せずにFD(1..4)から起動、インストーラ画面表示無し |
|ID=0,LUN=0デバイスが不在、またはエラー| エラー表示をしてキー入力待ち、パーティションを無効にして　メニューモードへ移行|
|パーティションレコード無効| エラー表示をしてキー入力待ち、パーティションをMZ-1E30に設定して　メニューモードへ移行|
|パーティションレコード有効| 一定時間キー入力待ちの後、起動指定されたパーティションを自動起動|

SHIFTキー が押されていない場合は起動メッセージ表示後にHD内のパーティションレコードを読み込みます。  
起動時エラー発生、または一定時間内にスペースキーを押すとメニューモードへ移行します。  
メニューモードでは全パーティションの情報を表示して、下記のキー受け付け待ちを行います。  
メニューモードに入らなくも一定時間は下記のキーは受け付けます。  

| キー入力／状態 |  動作 | 
|:---:|:---|
|無し| HDの起動指定パーティションから自動起動|
|スペース| メニューモードへ移行|
|1/2/3/4| FD1/2/3/4 から起動,HDドライバは拡張|
|F1/F2/F3/F4| HD1/2/3/4 から起動|
|F5..F10| パーティション HD0: F5..F10 を一時的(※)に入れ替える|
|SHIFT+F1..F5| パーティション HD0: と F11..F15 を一時的に入れ替える|
|F|FD1-4をHD1-4でエミュレートして、エミュレートされたFD1から起動(実験用)|
|E|EMMをHD1でエミュレートして、エミュレートされたEMMから起動(実験用)|
|V|EMMをHD1でエミュレートして、FD1から起動(実験用)|

※一時的なパーティションの入れ替えは保存されません。次回起動時には元に戻ります。

## HDパーティションデータの生成と管理

現在のパーティション設定値とHDに記録されたパーティションレコードの
内容を閲覧、管理するツールが"ROM:"デバイスに格納されています。  

パーティション情報は第１ドライブ(ID=0,LUN=0)のセクター３のみに記録されます。  
複数ドライブで利用する場合は第２ドライブ以降にパーティション情報が含まれないことに注意して下さい。  

* BASIC M25から `"ROM:HD PARTITION.m25"` を実行します。  
  現在のパーティション設定値とHDに記録されたパーティションレコードが表示されます。  

* メニューが表示されたら`'G'`(generate),`'1'`(MZ-1E30)を入力します。  
　MZ-1E30と互換性のあるパーティション情報が設定、表示されます。  
　問いに対して"Y"を入力するとパーティション情報をHDに書き込みます。  

* 起動指定ドライブを`HD1`以外にしたい場合は`'S'`コマンドで設定を行います。  
  したいHDと
　パーティションを選び、"Priorityboot'に'1'を指定すると起動ドライブを
　変更できます。変更を適用する場合は'W'コマンドでHDに書き込みます。

* メニューで`'G'`(generate),`'9'`(MAX)を選ぶと確保可能な最大容量で領域を確保します。  
　(33 + 65280 x15)*256 = 250683648 バイトのHDイメージを用意してください    
　(linuxでは"dd if=/dev/zero of=max_capacity.hdd bs=256 count=979233" )   

* 現在は個別のパーティションを細かく編集する機能はありませんので、  
　必要に応じて `edit *GEN_1E30` などを実行してプログラムコードを書き換えて下さい。  
　※各パーティションの最大容量は 65280(0x00_FF00) ブロックです。

## 各パーティションの初期化(論理フォーマット)

HDをMZ-2500標準フィルシステムで論理フォーマットを行うプログラムが
"ROM:"デバイスに格納されています。

パーティションデータを生成していない場合は、先にパーティションデータを
設定して、BASIC M25を　「再起動」　してから論理フォーマットを行って
下さい。

拡張メモリが無い場合は`アルゴ機能の選択を全てOFF`にして起動した `BASIC M25 Ver.1.0A` で実行してください。

* 本ROMを組み込んだ状態でBASIC M25を起動してから  
　`RUN "ROM:HD FORMAT.m25" {RETURN}`  
　を実行してフォーマットプログラムを起動します。  

* "Generate System Boot Drive (Y/N)"に"Y"か"N"で答えます。  
　"Y"を入力するとFD等の起動メディアから起動ファイルをコピーしてIPL起動するドライブを生成します。    
　"Y"以外を入力するデータドライブを生成します。    

* "Generate System Boot Drive (Y/N)"に"Y"で答えた場合は  
  次に"Copy ALGO Files"と問われるので"Y"か"N"で答えます。  
  "Y"を入力するとFD等の起動メディアからアルゴ機能として登録されているファイルがFD等の起動メディアからHDにコピーされます。  
  "Y"以外を入力するとデータドライブ として論理フォーマットを行います。

* "Generate System Boot Drive (Y/N)"に"Y"で答えた場合は  
  "Input source System Drive (FD1:)?"とと問われるので、読み込ませる起動メディアのデバイス名を入力します。  
  そのままリターンキーを押すと"FD1:"が選択されます。  
  ここでシステムファイルがスキャンされますが、フォーマット後に必要な
  データをコピーしますので、フォーマットが終了するまでシステムデバイスを
  抜かないで下さい。


* "Input format HD number"に対してフォーマット対象のドライブ番号を"1"から"4"で入力します。  
  ドライブ容量を自動取得して、適切なファイルシステムのパラメータを自動生成します。

* "Are You Sure(Y/N)?に対して'Y'キーを押すとフォーマットを実行します。
  システムドライブを選択している場合にはフォーマット後にSys Loaderや  
  システムファイルを参照デバイスからコピーされます。  
  初期化を行うと全てのファイルは消去されます。

## 謝辞

有志の方々が調査、公開されておられる各資料や直接情報提供により、  
MZ-1E30内蔵ROMコードに直接触れることなく実装することができました。  
特に

* MZ-1E30の仕様を丁寧に調査、公開された Ｏｈ！石氏
* 実機での動作を確認していただいた かねごん氏
* SASI I/F基板を制作、提供していただいた sunMaru氏
* 更新毎にテストと御意見をいただいた issaUt氏

のご協力なくして作ることは出来なかったと思います。  
他にもSNSでいくつか有用な情報を教えていただきました。  
ご協力いただいた全ての方々に、この場を借りて御礼を申し上げます。  

## 参考資料

* シャープ博物館,[MZ-1E30(MZ-2500/2800用HDD I/Fボード)](http://retropc.net/ohishi/museum/mz1e30.htm)
* シャープ株式会社,MZ-1E30取扱説明書
* シャープ株式会社,MZ-2500オーナーズマニュアル
* 工学社、MZ-2500テクニカル* マニュアル
* アルゴの記憶、[MZ-2500 のディスクについて](https://daimonsoft.info/argo/mz2500disk.html)
* MZ-2500 IOCSソースファイル(LST)

## ライセンス

本プログラムにおけるオリジナルコードの著作権は すーぱーたーぼ に帰属します。

[Creative Commons,表示-継承 4.0](https://creativecommons.org/licenses/by-sa/4.0/deed.ja)
<img height="30" alt="CC=BY-SA" src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/CC_BY-SA_icon.svg/176px-CC_BY-SA_icon.svg.png">
